<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语听力练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3;
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #68838B; 
            padding: 10px 0; 
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 3px solid #5d757d; 
            background: #0f1314; 
            color: #fffbef; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #68838B; 
            background: #FFAD5B; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 4px solid orange; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #734A2E; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #734A2E;
            background: #ffffff; /*E6EDD9*/
            color: #000;
            font-size: 30px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 20px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0.533083,
        "end": 3.573083,
        "correctAnswer": "Ngoài học giỏi, cô ấy còn chơi đàn rất hay.",
        "translation": "除了学习好，她还弹琴弹得很好。",
        "options": [
            "Ngoài học giỏi, cô ấy còn chơi đàn rất hay.",
            "Ngoài học giỏi, cô ấy còn trơi đàn rất hay.",
            "Ngoài học giỏi, cô ấy còn chơi đần rất hay.",
            "Ngoài học giỏi, cô ấy còn chơi đàn rât hay."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.203083,
        "end": 7.373083,
        "correctAnswer": "Ngoài rau, mẹ còn mua thêm thịt và cá.",
        "translation": "除了买蔬菜，妈妈还买了肉和鱼。",
        "options": [
            "Ngoài rau, mẹ còn mua thêm thịt và cá.",
            "Ngoài râu, mẹ còn mua thêm thịt và cá.",
            "Ngoài rau, mẹ còn mua thêm thịt và gá.",
            "Ngoài rau, mẹ còn mua thêm thịt và cả."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 8.023083,
        "end": 11.243083,
        "correctAnswer": "Ngoài Hà Nội, chúng tôi còn đi Huế và Đà Nẵng.",
        "translation": "除了河内，我们还去了顺化和岘港。",
        "options": [
            "Ngoài Hà Nội, chúng tôi còn đi Huế và Đà Nẵng.",
            "Ngoài Hà Nội, chúng tôi còn đi Huế và Đà Nẵm.",
            "Ngoài Hà Nội, chúng tôi còn đi Huế và Đà Náo.",
            "Ngoài Hà Nội, chúng tôi còn đi Huế và Đa Nẵng."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 12.003083,
        "end": 14.903083,
        "correctAnswer": "Ngoài sở thích đọc sách, em còn thích vẽ tranh.",
        "translation": "除了喜欢看书，我还喜欢画画。",
        "options": [
            "Ngoài sở thích đọc sách, em còn thích vẽ tranh.",
            "Ngoài sợ thích đọc sách, em còn thích vẽ tranh.",
            "Ngoài sở thích đọc sách, em còn thíc vẽ tranh.",
            "Ngoài sở thích đọc sách, em còn thích vẽ chanh."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 15.473083,
        "end": 18.513083,
        "correctAnswer": "Ngoài việc nấu ăn, bà tôi còn thích làm vườn.",
        "translation": "除了做饭，我奶奶还喜欢种菜。",
        "options": [
            "Ngoài việc nấu ăn, bà tôi còn thích làm vườn.",
            "Ngoài việc nấu ăn, bà tôi còn thích làm vươn.",
            "Ngoài việc nấu ăn, bà tôi còn thíc làm vườn.",
            "Ngoài việc nấu ăn, bà tôi còn thích làm vừơn."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 19.163083,
        "end": 22.163083,
        "correctAnswer": "Tôi học tiếng Việt, ngoài ra còn học tiếng Anh.",
        "translation": "我学越南语，此外还学英语。",
        "options": [
            "Tôi học tiếng Việt, ngoài ra còn học tiếng Anh.",
            "Tôi học tiếng Việt, ngoài ra còn học tiêng Anh.",
            "Tôi học tiếng Việt, ngoài ra còn học tiếng Ánh.",
            "Tôi học tiếng Việt, ngoài ra còn học tiếng Anhh."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 22.973083,
        "end": 26.153083,
        "correctAnswer": "Cô ấy rất xinh đẹp, ngoài ra còn hát hay.",
        "translation": "她很漂亮，此外还唱歌很好听。",
        "options": [
            "Cô ấy rất xinh đẹp, ngoài ra còn hát hay.",
            "Cô ấy rất xinh đẹp, ngoài ra còn hắt hay.",
            "Cô ấy rất xinh đẹp, ngoài ra còn hát hây.",
            "Cô ấy rất xinh đẹp, ngoài ra còn hát hai."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.063083,
        "end": 31.333083,
        "correctAnswer": "Hôm nay tôi phải học bài mới, ngoài ra còn làm bài tập nhóm.",
        "translation": "今天我得学习新课，还得做小组作业。",
        "options": [
            "Hôm nay tôi phải học bài mới, ngoài ra còn làm bài tập nhóm.",
            "Hôm nay tôi phải học bài mới, ngoài ra còn làm bày tập nhóm.",
            "Hôm nay tôi phải học bài mới, ngoài ra còn làm bài tập nhõm.",
            "Hôm nay tôi phải học bài mới, ngoài ra còn làm bài tậm nhóm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 32.413083,
        "end": 36.743083,
        "correctAnswer": "Anh ấy làm việc ở công ty, ngoài ra còn làm phiên dịch tự do.",
        "translation": "他在公司工作，此外还做自由翻译。",
        "options": [
            "Anh ấy làm việc ở công ty, ngoài ra còn làm phiên dịch tự do.",
            "Anh ấy làm việc ở công ty, ngoài ra còn làm phiên dích tự do.",
            "Anh ấy làm việc ở công ty, ngoài ra còn làm phiên dịch tự dô.",
            "Anh ấy làm việc ở công ty, ngoài ra còn làm phiên dịc tự do."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 37.463083,
        "end": 41.803083,
        "correctAnswer": "Trường có nhiều hoạt động nghiên cứu, ngoài ra còn tổ chức hội thảo mỗi tháng.",
        "translation": "学校有很多研究活动，此外每个月还举办讲座。",
        "options": [
            "Trường có nhiều hoạt động nghiên cứu, ngoài ra còn tổ chức hội thảo mỗi tháng.",
            "Trường có nhiều hoạt động nghiên cứu, ngoài ra còn tổ chức hội thảo mỗi thảng.",
            "Trường có nhiều hoạt động nghiên cứu, ngoài ra còn tổ chức hội thạo mỗi tháng.",
            "Trường có nhiều hoạt động nghiên cứu, ngoài ra còn tổ chức hội thảo mỗi thánh."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 43.223083,
        "end": 46.573083,
        "correctAnswer": "Tôi mua sách, ngoài ra còn mua thêm vở và bút.",
        "translation": "我买了书，此外还买了笔记本和笔。",
        "options": [
            "Tôi mua sách, ngoài ra còn mua thêm vở và bút.",
            "Tôi mua sách, ngoài ra còn mua thêm vỡ và bút.",
            "Tôi mua sách, ngoài ra còn mua thêm vở và bụt.",
            "Tôi mua sách, ngoài ra còn mua thên vở và bút."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 47.693083,
        "end": 51.733083,
        "correctAnswer": "Bởi trời mưa to nên đường trơn, vì vậy tôi đi rất chậm.",
        "translation": "因为下大雨，路很滑，所以我走得很慢。",
        "options": [
            "Bởi trời mưa to nên đường trơn, vì vậy tôi đi rất chậm.",
            "Bởi trời mưa to nên đường trơn, vì vậy tôi đi rất chấm.",
            "Bởi trời mưa to nên đường chơn, vì vậy tôi đi rất chậm.",
            "Bởi trời mưa to nên đường trơn, vì vậy tôi đi rất chẳm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 52.833083,
        "end": 57.253083,
        "correctAnswer": "Bởi cô ấy bị ốm nên không đi học, vì vậy tôi chép bài giúp.",
        "translation": "因为她生病了，没去上课，所以我帮她抄笔记。",
        "options": [
            "Bởi cô ấy bị ốm nên không đi học, vì vậy tôi chép bài giúp.",
            "Bởi cô ấy bị ốm nên không đi học, vì vậy tôi chép bải giúp.",
            "Bởi cô ấy bị ốm nên không đi học, vì vậy tôi ché bày giúp.",
            "Bởi cô ấy bị ốm nên không đi học, vì vậy tôi chép bài giụp."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 58.233083,
        "end": 63.043083,
        "correctAnswer": "Bởi hôm qua thức khuya nên sáng nay dậy muộn, vì vậy trễ giờ học.",
        "translation": "因为昨晚熬夜，所以今天早上起晚了，上课迟到了。",
        "options": [
            "Bởi hôm qua thức khuya nên sáng nay dậy muộn, vì vậy trễ giờ học.",
            "Bởi hôm qua thức khuya nên sáng nay dậy muộn, vì vậy trễ dờ học.",
            "Bởi hôm qua thức khuya nên sáng nay dậy muộn, vì vậy trễ giờ hộc.",
            "Bởi hôm qua thức khuya nên sáng nay dậy muộn, vì vậy chễ giờ học."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 64.003083,
        "end": 69.323083,
        "correctAnswer": "Bởi không chuẩn bị kỹ nên buổi thuyết trình chưa tốt, vì vậy nhóm tôi phải làm lại.",
        "translation": "因为准备不充分，演讲效果不好，所以我们组要重新做。",
        "options": [
            "Bởi không chuẩn bị kỹ nên buổi thuyết trình chưa tốt, vì vậy nhóm tôi phải làm lại.",
            "Bởi không chuẩn bị kỹ nên buổi thuyết trình chưa tốt, vì vậy nhóm tôi phải làm lãi.",
            "Bởi không chuẩn bị kỹ nên buổi thuyết trình chưa tốt, vì vậy nhõm tôi phải làm lại.",
            "Bởi không chuẩn bị kỹ nên buổi thuyết trình chưa tốt, vì vậy nhóm tôi phãi làm lại."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 70.173083,
        "end": 72.783083,
        "correctAnswer": "Trời mưa to quá, tôi đành ở nhà.",
        "translation": "雨太大了，我只好待在家里。",
        "options": [
            "Trời mưa to quá, tôi đành ở nhà.",
            "Trời mưa to quá, tôi đành ở nha.",
            "Trời mưa to quá, tôi đành ỡ nhà.",
            "Trời mưa to quá, tôi dành ở nhà."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 73.503083,
        "end": 76.813083,
        "correctAnswer": "Quán ăn này đóng cửa rồi, chúng tôi đành đi nơi khác.",
        "translation": "这家餐馆关门了，我们只好去别的地方。",
        "options": [
            "Quán ăn này đóng cửa rồi, chúng tôi đành đi nơi khác.",
            "Quán ăn này đóng cửa rồi, chúng tôi đành đi nươi khác.",
            "Quán ăn này đóng cửa rồi, chúng tôi đành đi nơi khắc.",
            "Quán ăn này đóng cửa rồi, chúng tôi dành đi nơi khác."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 77.753083,
        "end": 80.803083,
        "correctAnswer": "Không có ai giúp, anh ấy đành tự làm một mình.",
        "translation": "没有人帮忙，他只好自己一个人做。",
        "options": [
            "Không có ai giúp, anh ấy đành tự làm một mình.",
            "Không có ai giúp, anh ấy đành tự lằm một mình.",
            "Không có ai giúp, anh ấy đành tự làm một mihf.",
            "Không có ai giúp, anh ấy dành tự làm một mình."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 81.883083,
        "end": 84.183083,
        "correctAnswer": "Không gọi được xe, tôi đành đi bộ.",
        "translation": "叫不到车，我只好走路。",
        "options": [
            "Không gọi được xe, tôi đành đi bộ.",
            "Không gọi được xe, tôi đành đi bô.",
            "Không gọi được xe, tôi đành đi bọ.",
            "Không gọi được xe, tôi dành đi bộ."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 84.963083,
        "end": 88.313083,
        "correctAnswer": "Không mang ô, chúng tôi đành trú mưa ở nhà xe.",
        "translation": "没带伞，我们只好在车棚里避雨。",
        "options": [
            "Không mang ô, chúng tôi đành trú mưa ở nhà xe.",
            "Không mang ô, chúng tôi đành trũ mưa ở nhà xe.",
            "Không mang ô, chúng tôi đành trú mưa ở nhá xe.",
            "Không mang ô, chúng tôi dành trú mưa ở nhà xe."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 89.093083,
        "end": 91.883083,
        "correctAnswer": "Không tìm thấy sách, em đành mượn của bạn.",
        "translation": "找不到书，我只好借同学的。",
        "options": [
            "Không tìm thấy sách, em đành mượn của bạn.",
            "Không tìm thấy sách, em dành mượn của bạn.",
            "Không tìm thấy sách, em đành mượn của bạng.",
            "Không tìm thấy sách, em đành muợn của bạn."
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 20px; font-weight: normal; color: #38761d;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>